<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph Loop Status - Live Execution Monitor</title>
    <style>
        :root {
            --bg-deep: #050810;
            --bg-card: #0a0f1c;
            --bg-card-hover: #0f1419;
            --accent: #667eea;
            --gold: #ffd700;
            --text: #e0e0e0;
            --text-dim: #888;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #ef4444;
            --border: #1a1f2e;
            --code-bg: #0d1117;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            background: var(--bg-deep);
            color: var(--text);
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        .header h1 {
            color: var(--gold);
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: var(--text-dim);
            font-size: 1.1em;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .status-card h3 {
            color: var(--gold);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-dim);
        }

        .metric-value {
            font-weight: bold;
            color: var(--accent);
        }

        .loops-section {
            margin-bottom: 30px;
        }

        .section-header {
            color: var(--gold);
            font-size: 1.8em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loop-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .loop-header {
            background: var(--bg-card-hover);
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .loop-title {
            font-size: 1.3em;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .loop-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            font-size: 0.9em;
        }

        .loop-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: 400px;
        }

        .iterations-panel {
            padding: 20px;
            border-right: 1px solid var(--border);
        }

        .details-panel {
            padding: 20px;
            background: var(--bg-card-hover);
        }

        .iterations-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .iteration-item {
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 10px;
            padding: 15px;
        }

        .iteration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .iteration-number {
            font-weight: bold;
            color: var(--accent);
        }

        .iteration-timestamp {
            color: var(--text-dim);
            font-size: 0.8em;
        }

        .iteration-summary {
            color: var(--text-dim);
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .iteration-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.8em;
        }

        .detail-item {
            background: var(--bg-deep);
            padding: 8px;
            border-radius: 3px;
        }

        .detail-label {
            color: var(--text-dim);
            margin-bottom: 3px;
        }

        .detail-value {
            color: var(--text);
            word-break: break-word;
        }

        .current-iteration {
            border-left: 3px solid var(--accent);
            background: rgba(102, 126, 234, 0.1);
        }

        .files-changed {
            margin-top: 20px;
        }

        .files-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: var(--code-bg);
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        .command-log {
            margin-top: 20px;
        }

        .command-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--code-bg);
            border-radius: 4px;
            padding: 10px;
        }

        .command-item {
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-deep);
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8em;
        }

        .command-timestamp {
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .command-text {
            color: var(--warning);
        }

        .command-result {
            color: var(--text);
            margin-top: 4px;
            white-space: pre-wrap;
            font-size: 0.8em;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-running { background: var(--accent); color: white; }
        .status-complete { background: var(--success); color: black; }
        .status-error { background: var(--error); color: white; }
        .status-paused { background: var(--warning); color: black; }

        .no-loops {
            text-align: center;
            color: var(--text-dim);
            padding: 40px;
            font-style: italic;
        }

        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1000;
        }

        .refresh-btn:hover {
            background: #5a67d8;
        }

        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 140px;
            background: var(--bg-card);
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .loop-content {
                grid-template-columns: 1fr;
            }

            .iterations-panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Ralph Loop Status Monitor</h1>
            <p>Live execution dashboard for autonomous Ralph Wiggum loops</p>
        </div>

        <div class="status-overview" id="status-overview">
            <div class="status-card">
                <h3>üìä System Status</h3>
                <div class="metric">
                    <span class="metric-label">Active Loops</span>
                    <span class="metric-value" id="active-loops">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Iterations</span>
                    <span class="metric-value" id="total-iterations">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Completed Tasks</span>
                    <span class="metric-value" id="completed-tasks">0</span>
                </div>
            </div>

            <div class="status-card">
                <h3>‚ö° Current Activity</h3>
                <div class="metric">
                    <span class="metric-label">Running Loops</span>
                    <span class="metric-value" id="running-loops">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Commands Executed</span>
                    <span class="metric-value" id="commands-executed">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Files Modified</span>
                    <span class="metric-value" id="files-modified">0</span>
                </div>
            </div>

            <div class="status-card">
                <h3>üéØ Success Rate</h3>
                <div class="metric">
                    <span class="metric-label">Completion Rate</span>
                    <span class="metric-value" id="completion-rate">0%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Average Iterations</span>
                    <span class="metric-value" id="avg-iterations">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Success Rate</span>
                    <span class="metric-value" id="success-rate">0%</span>
                </div>
            </div>
        </div>

        <div class="loops-section">
            <div class="section-header">
                <span>üîÑ Active Ralph Loops</span>
            </div>

            <div id="loops-container">
                <div class="no-loops">
                    <p>No active Ralph loops found.</p>
                    <p>Start a loop by switching to ralph-loop mode in RooCode.</p>
                </div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshStatus()">üîÑ Refresh</button>
    <div class="auto-refresh" id="auto-refresh-status">Auto-refresh: ON</div>

    <script>
        let ralphLoops = [];
        let commandHistory = [];
        let autoRefreshInterval;

        async function loadRalphLoops() {
            try {
                // Load all task files from .ralph directory
                const response = await fetch('/api/ralph-loops'); // This would need a backend endpoint
                const data = await response.json();
                ralphLoops = data.loops || [];

                // Fallback: simulate loading from local files (would need server proxy)
                if (ralphLoops.length === 0) {
                    ralphLoops = await loadLocalLoops();
                }

                updateUI();
            } catch (error) {
                console.error('Failed to load Ralph loops:', error);
                // Load mock data for demo
                ralphLoops = await loadMockData();
                updateUI();
            }
        }

        async function loadLocalLoops() {
            // This would need a backend API to read .ralph directory
            // For now, return mock data
            return loadMockData();
        }

        async function loadMockData() {
            // Mock data for demonstration
            return [
                {
                    task_name: "implement_jwt_auth",
                    task: "Implement JWT authentication system",
                    completion_promise: "AUTH_COMPLETE",
                    current_iteration: 3,
                    max_iterations: 25,
                    status: "running",
                    start_time: new Date().toISOString(),
                    overall_progress: "60% complete - JWT middleware implemented",
                    iteration_notes: {
                        "1": {
                            completed: ["Installed jwt library", "Created auth models"],
                            attempted: ["JWT token generation"],
                            remaining: ["Login endpoint", "Register endpoint", "Middleware"],
                            verification_results: ["Tests failing", "Compilation successful"]
                        },
                        "2": {
                            completed: ["JWT token generation", "Basic login logic"],
                            attempted: ["Password hashing"],
                            remaining: ["Register endpoint", "Token validation"],
                            verification_results: ["Login tests passing", "Register tests failing"]
                        },
                        "3": {
                            completed: ["Token validation middleware", "Register endpoint"],
                            attempted: ["Email verification"],
                            remaining: ["Complete integration tests"],
                            verification_results: ["Core auth working", "Need more tests"]
                        }
                    },
                    files_modified: [
                        "backend/src/models/User.js",
                        "backend/src/routes/auth.js",
                        "backend/src/middleware/auth.js",
                        "backend/tests/auth.test.js"
                    ],
                    commands_executed: [
                        { timestamp: "2024-01-17T10:30:00Z", command: "npm install jsonwebtoken bcryptjs", result: "installed" },
                        { timestamp: "2024-01-17T10:35:00Z", command: "python3 tools/ralph_loop_manager.py context", result: "loaded iteration 3" },
                        { timestamp: "2024-01-17T10:40:00Z", command: "npm test", result: "3 passing, 1 failing" }
                    ]
                }
            ];
        }

        function updateUI() {
            updateOverview();
            updateLoops();
        }

        function updateOverview() {
            const activeLoops = ralphLoops.length;
            const runningLoops = ralphLoops.filter(l => l.status === 'running').length;
            const completedTasks = ralphLoops.filter(l => l.status === 'complete').length;
            const totalIterations = ralphLoops.reduce((sum, loop) => sum + loop.current_iteration, 0);
            const completionRate = activeLoops > 0 ? Math.round((completedTasks / activeLoops) * 100) : 0;
            const avgIterations = completedTasks > 0 ? Math.round(totalIterations / completedTasks) : 0;
            const successRate = activeLoops > 0 ? Math.round((completedTasks / activeLoops) * 100) : 0;

            document.getElementById('active-loops').textContent = activeLoops;
            document.getElementById('running-loops').textContent = runningLoops;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-iterations').textContent = totalIterations;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('avg-iterations').textContent = avgIterations;
            document.getElementById('success-rate').textContent = `${successRate}%`;
        }

        function updateLoops() {
            const container = document.getElementById('loops-container');

            if (ralphLoops.length === 0) {
                container.innerHTML = '<div class="no-loops"><p>No active Ralph loops found.</p><p>Start a loop by switching to ralph-loop mode in RooCode.</p></div>';
                return;
            }

            container.innerHTML = ralphLoops.map(loop => createLoopCard(loop)).join('');
        }

        function createLoopCard(loop) {
            const progressPercent = calculateProgress(loop);
            const statusClass = `status-${loop.status}`;

            return `
                <div class="loop-card">
                    <div class="loop-header">
                        <div class="loop-title">${formatTaskName(loop.task_name)}</div>
                        <span class="status-badge ${statusClass}">${loop.status}</span>
                        <div class="loop-meta">
                            <div><strong>Task:</strong> ${loop.task}</div>
                            <div><strong>Promise:</strong> ${loop.completion_promise}</div>
                            <div><strong>Iteration:</strong> ${loop.current_iteration}/${loop.max_iterations}</div>
                            <div><strong>Started:</strong> ${formatDate(loop.start_time)}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 5px; font-size: 0.9em; color: var(--text-dim);">
                            ${loop.overall_progress}
                        </div>
                    </div>

                    <div class="loop-content">
                        <div class="iterations-panel">
                            <h4>üìã Iteration History</h4>
                            <div class="iterations-list">
                                ${createIterationsList(loop)}
                            </div>
                        </div>

                        <div class="details-panel">
                            <div class="files-changed">
                                <h4>üìÅ Files Modified</h4>
                                <div class="files-list">
                                    ${loop.files_modified ? loop.files_modified.map(file => `<div class="file-item">${file}</div>`).join('') : '<div class="file-item">No files modified yet</div>'}
                                </div>
                            </div>

                            <div class="command-log">
                                <h4>‚ö° Recent Commands</h4>
                                <div class="command-list">
                                    ${loop.commands_executed ? loop.commands_executed.slice(-5).map(cmd => `
                                        <div class="command-item">
                                            <div class="command-timestamp">${formatDate(cmd.timestamp)}</div>
                                            <div class="command-text">> ${cmd.command}</div>
                                            <div class="command-result">${cmd.result}</div>
                                        </div>
                                    `).join('') : '<div class="command-item">No commands executed yet</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createIterationsList(loop) {
            const iterations = Object.entries(loop.iteration_notes || {})
                .sort(([a], [b]) => parseInt(b) - parseInt(a)) // Most recent first
                .map(([iterNum, notes]) => {
                    const isCurrent = parseInt(iterNum) === loop.current_iteration;
                    return `
                        <div class="iteration-item ${isCurrent ? 'current-iteration' : ''}">
                            <div class="iteration-header">
                                <span class="iteration-number">Iteration ${iterNum}</span>
                                <span class="iteration-timestamp">${isCurrent ? 'CURRENT' : 'Completed'}</span>
                            </div>
                            <div class="iteration-summary">
                                <strong>Completed:</strong> ${notes.completed?.join(', ') || 'None'}<br>
                                <strong>Attempted:</strong> ${notes.attempted?.join(', ') || 'None'}<br>
                                <strong>Remaining:</strong> ${notes.remaining?.join(', ') || 'None'}
                            </div>
                            <div class="iteration-details">
                                <div class="detail-item">
                                    <div class="detail-label">Verification</div>
                                    <div class="detail-value">${notes.verification_results?.join(', ') || 'None'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

            return iterations.length > 0 ? iterations.join('') : '<div class="iteration-item"><em>No iterations recorded yet</em></div>';
        }

        function calculateProgress(loop) {
            if (loop.status === 'complete') return 100;
            if (loop.status === 'error') return 0;

            const current = loop.current_iteration;
            const max = loop.max_iterations;
            return Math.min(Math.round((current / max) * 100), 95); // Leave room for completion
        }

        function formatTaskName(name) {
            return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return dateString;
            }
        }

        function refreshStatus() {
            loadRalphLoops();
        }

        function toggleAutoRefresh() {
            const status = document.getElementById('auto-refresh-status');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                status.textContent = 'Auto-refresh: OFF';
            } else {
                autoRefreshInterval = setInterval(refreshStatus, 5000);
                status.textContent = 'Auto-refresh: ON';
            }
        }

        // Initialize
        loadRalphLoops();

        // Auto-refresh
        autoRefreshInterval = setInterval(refreshStatus, 5000);

        // Toggle auto-refresh on click
        document.getElementById('auto-refresh-status').addEventListener('click', toggleAutoRefresh);
    </script>
</body>
</html>