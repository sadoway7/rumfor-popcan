<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ralph Infinity List - Rumfor Market Tracker</title>
    <style>
      :root {
        --bg-deep: #0c1016;
        --bg-panel: #121826;
        --text: #f5f7fb;
        --muted: #94a3b8;
        --accent: #60a5fa;
        --success: #34d399;
        --warning: #fbbf24;
        --danger: #f87171;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, system-ui, sans-serif;
        background: radial-gradient(circle at top, #111827, #0c1016 55%);
        color: var(--text);
        display: grid;
        grid-template-columns: 280px minmax(0, 1fr) 340px;
        height: 100vh;
      }
      header {
        grid-column: 1 / -1;
        padding: 18px 28px;
        background: #0b1220;
        border-bottom: 1px solid #1f2937;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header .title {
        font-weight: 700;
        font-size: 18px;
      }
      header .subtitle {
        color: var(--muted);
        font-size: 13px;
      }
      .panel {
        padding: 18px;
        border-right: 1px solid #1f2937;
        overflow: auto;
      }
      .panel.right {
        border-right: none;
        border-left: 1px solid #1f2937;
      }
      .card {
        background: var(--bg-panel);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 12px;
      }
      .card.sticky {
        position: sticky;
        top: 16px;
        z-index: 5;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.35);
      }
      .card-list {
        display: grid;
        gap: 8px;
      }
      .card-item {
        border: 1px solid #24324a;
        border-radius: 10px;
        padding: 10px;
        background: #0b1220;
        display: grid;
        gap: 6px;
        cursor: pointer;
        transition: border 0.2s ease;
      }
      .card-item:hover {
        border-color: #3b82f6;
      }
      .card-item.selected {
        border-color: #60a5fa;
        background: rgba(96, 165, 250, 0.08);
      }
      .card-detail {
        border: 1px dashed #334155;
        border-radius: 12px;
        padding: 12px;
        background: #0b1220;
        min-height: 220px;
      }
      .cards-toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .cards-toolbar.sticky {
        position: sticky;
        top: 16px;
        z-index: 4;
        background: var(--bg-panel);
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #1f2937;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
      }
      .cards-toolbar input {
        flex: 1;
      }
      .badge {
        background: #1f2937;
        border: 1px solid #334155;
        color: #e2e8f0;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
      }
      .card-item .prompt-preview {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .card-item .meta-row {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }
      .section-title {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 8px;
      }
      .editor-status {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 10px;
        display: grid;
        gap: 4px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #1f2937;
        border: 1px solid #334155;
        color: #e2e8f0;
      }
      .field {
        display: grid;
        gap: 6px;
      }
      input, textarea, select {
        width: 100%;
        background: #0b1220;
        color: var(--text);
        border: 1px solid #24324a;
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 13px;
      }
      input::placeholder, textarea::placeholder {
        color: #64748b;
      }
      button {
        background: linear-gradient(135deg, #60a5fa, #38bdf8);
        color: #0b1220;
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: #1f2937;
        color: #e2e8f0;
        border: 1px solid #334155;
      }
      .agent-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .agent {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-radius: 10px;
        background: #0b1220;
        border: 1px solid #1f2937;
      }
      .agent button {
        background: var(--accent);
        color: #0b1220;
        border: none;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .muted { color: var(--muted); }
      .status-idle { color: var(--muted); }
      .status-running { color: var(--warning); }
      .status-complete { color: var(--success); }
      .status-error { color: var(--danger); }
      .toast {
        position: fixed;
        bottom: 16px;
        right: 16px;
        background: #1f2937;
        padding: 10px 14px;
        border-radius: 10px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .toast.show { opacity: 1; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <div class="title">Ralph Infinity List</div>
        <div class="subtitle">Rumfor Market Tracker â€¢ World Model & Agents</div>
      </div>
      <div class="subtitle">v1</div>
    </header>

    <aside class="panel">
      <div class="card">
        <div class="section-title">Card Editor</div>
        <div id="editor-status" class="editor-status">
          <div><strong>Steps:</strong> 1) Select a card 2) Edit fields 3) Save</div>
          <div>Saving writes directly to <code>cards/</code> (no file browser).</div>
        </div>
        <div style="display: grid; gap: 10px;">
          <div class="field">
            <label class="muted" for="card-id">Card ID</label>
            <input id="card-id" placeholder="Markets.Discovery" />
          </div>
          <div class="field">
            <label class="muted" for="card-label">Label</label>
            <input id="card-label" placeholder="Market Discovery" />
          </div>
          <div class="field">
            <label class="muted" for="card-type">Type</label>
            <select id="card-type">
              <option value="category">category</option>
              <option value="card">card</option>
            </select>
          </div>
          <div class="field">
            <label class="muted" for="card-prompt">Prompt</label>
            <textarea id="card-prompt" rows="5" placeholder="Describe the task/context..."></textarea>
          </div>
          <div class="field">
            <label class="muted" for="card-notes">Notes (Markdown)</label>
            <textarea id="card-notes" rows="6" placeholder="Add details, checklist, links..."></textarea>
          </div>
          <div id="editor-files" class="muted" style="font-size: 12px;">
            Files will save to <code>cards/</code> using the card ID.
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button id="card-save" type="button">Save</button>
            <button id="card-clear" class="secondary" type="button">Clear</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="panel">
      <div class="card sticky">
        <div class="section-title">Card Details</div>
        <div id="card-detail" class="card-detail muted">Select a card to view its prompt.</div>
      </div>
      <div class="card">
        <div class="section-title">Cards</div>
        <div class="cards-toolbar sticky">
          <input id="cards-filter" placeholder="Filter cards..." />
          <span id="cards-count" class="badge">0</span>
        </div>
        <div id="cards-list" class="card-list"></div>
      </div>
    </main>

    <aside class="panel right">
      <div class="card">
        <h3>Ralph Orchestrator</h3>
        <div id="orchestrator-status" class="muted">Status: loading...</div>
        <div id="orchestrator-cycle" class="muted">Cycle: --</div>
        <div id="orchestrator-agent" class="muted">Current: --</div>
      </div>
      <div class="card">
        <h4>Agents</h4>
        <div id="agent-grid" class="agent-grid"></div>
        <button id="run-all" style="margin-top: 12px; width: 100%;">Run All Agents</button>
      </div>
    </aside>

    <div id="toast" class="toast"></div>

    <script src="ralph_status.js"></script>
    <script>
      let cardsCache = [];
      let selectedCard = null;
      let selectedCards = [];

      window.ralphCards = [
        {
          id: "Markets.Discovery",
          label: "Market Discovery",
          type: "card",
          prompt: "Improve market discovery UX: simplify filters, prioritize location-first results, and surface trending hashtags without overwhelming new users.",
          file: "market_discovery.dot",
          notes: "market_discovery.md"
        },
        {
          id: "Applications.Flow",
          label: "Application Flow",
          type: "card",
          prompt: "Reduce friction in the application flow: multi-step form, pre-fill from profile, auto-save drafts, and clear status timeline.",
          file: "application_flow.dot",
          notes: "application_flow.md"
        },
        {
          id: "Promoters.Claim",
          label: "Promoter Claiming",
          type: "card",
          prompt: "Clarify promoter claiming: eligibility criteria, verification steps, and clear CTA placement on market detail.",
          file: "promoter_claiming.dot",
          notes: "promoter_claiming.md"
        },
        {
          id: "Community.Photos",
          label: "Community Photos",
          type: "card",
          prompt: "Improve photo sharing: mobile upload flow, lightweight compression, and top-voted hero selection transparency.",
          file: "community_photos.dot",
          notes: "community_photos.md"
        },
        {
          id: "Community.Hashtags",
          label: "Hashtag Voting",
          type: "card",
          prompt: "Refine hashtag voting: limit noise, surface top tags, and align with market categories and accessibility filters.",
          file: "hashtag_voting.dot",
          notes: "hashtag_voting.md"
        },
        {
          id: "Tracking.Statuses",
          label: "Tracking Statuses",
          type: "card",
          prompt: "Clarify status progression (interested â†’ applied â†’ booked â†’ completed) with UI cues and timeline messaging.",
          file: "tracking_statuses.dot",
          notes: "tracking_statuses.md"
        },
        {
          id: "Notifications.System",
          label: "Notifications",
          type: "card",
          prompt: "Tune notifications: prioritize application updates, reduce noise, and ensure mobile-friendly delivery and settings.",
          file: "notifications.dot",
          notes: "notifications.md"
        },
        {
          id: "Tracking.Expenses",
          label: "Expense Tracking",
          type: "card",
          prompt: "Simplify expense tracking for market events: quick-entry form, category presets, and profit summary.",
          file: "expense_tracking.dot",
          notes: "expense_tracking.md"
        },
        {
          id: "UX.MobileAccessibility",
          label: "Mobile Accessibility",
          type: "card",
          prompt: "Audit mobile accessibility: 44px touch targets, contrast ratios, and keyboard navigation for modal flows.",
          file: "mobile_accessibility.dot",
          notes: "mobile_accessibility.md"
        },
        {
          id: "Onboarding.Friction",
          label: "Onboarding Friction",
          type: "card",
          prompt: "Reduce onboarding friction: progressive registration, social login options, and value before signup.",
          file: "onboarding_friction.dot",
          notes: "onboarding_friction.md"
        },
        {
          id: "Deployment.GitLab",
          label: "GitLab + Unraid Deployment",
          type: "card",
          prompt: "Optimize GitLab CI/CD pipeline for Unraid deployment: streamline Docker builds, improve caching, reduce image size, fix environment variables, ensure smooth container deployment. Keep changes minimal to avoid breaking existing GitLab CI/CD and Unraid Docker flow.",
          file: "deployment_gitlab_unraid.dot",
          notes: "",
          agents: "simple-solution,backend"
        }
      ];
      const agents = [
        {
          id: 'user_types',
          name: 'User Types',
          icon: 'ðŸ§‘â€ðŸ¤â€ðŸ§‘',
          slug: 'agent1-user-types',
          responsibility: 'Persona updates, UX alignment with user goals'
        },
        {
          id: 'market_types',
          name: 'Market Types',
          icon: 'ðŸ·ï¸',
          slug: 'agent2-market-types',
          responsibility: 'Market category and tagging updates'
        },
        {
          id: 'user_flows',
          name: 'User Flows',
          icon: 'ðŸ§­',
          slug: 'agent3-user-flows',
          responsibility: 'User flow design and validation'
        },
        {
          id: 'ui_styles',
          name: 'UI Styles',
          icon: 'ðŸŽ¨',
          slug: 'agent4-ui-styles',
          responsibility: 'UI styling, layout, and accessibility updates'
        },
        {
          id: 'community',
          name: 'Community',
          icon: 'ðŸ’¬',
          slug: 'agent5-community',
          responsibility: 'Community feature updates'
        },
        {
          id: 'applications',
          name: 'Applications',
          icon: 'ðŸ“',
          slug: 'agent6-applications',
          responsibility: 'Application workflow updates'
        },
        {
          id: 'backend',
          name: 'Backend',
          icon: 'ðŸ§©',
          slug: 'agent7-backend',
          responsibility: 'Backend logic and API changes'
        },
        {
          id: 'api',
          name: 'API',
          icon: 'ðŸ”Œ',
          slug: 'agent8-api',
          responsibility: 'API design and contract updates'
        },
        {
          id: 'documentation',
          name: 'Docs',
          icon: 'ðŸ“š',
          slug: 'agent9-docs',
          responsibility: 'Documentation updates'
        },
        {
          id: 'research',
          name: 'Research',
          icon: 'ðŸ”Ž',
          slug: 'agent10-research',
          responsibility: 'Investigations, technical research, root-cause analysis, evidence gathering'
        },
        {
          id: 'simple_solution',
          name: 'Simple Solution',
          icon: 'ðŸ©¹',
          slug: 'agent11-simple-solution',
          responsibility: 'Quick fixes, minimal changes, reducing scope, unblocking issues'
        },
        {
          id: 'logic',
          name: 'Logic',
          icon: 'ðŸ§ ',
          slug: 'agent12-logic',
          responsibility: 'Business logic fixes, workflow rule alignment, edge-case analysis'
        },
      ];

      const toast = document.getElementById('toast');
      function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1600);
      }

      function buildPrompt(agent) {
        let prompt = `I want to run the ${agent.name} Agent for Rumfor Market Tracker.\n\n`;
        if (selectedCards.length) {
          selectedCards.forEach(card => {
            prompt += `Context from World Model card "${card.id}":\n${card.prompt}\n\n`;
          });
          prompt += `Please use this context while working as the ${agent.name} Agent.\n\n`;
        }
        prompt += `Switch to the ${agent.slug} mode and complete the ${agent.name} Agent's responsibilities.`;
        return prompt;
      }

      function buildRunAllPrompt() {
        const lines = agents
          .map((agent, index) =>
            `${index + 1}. ${agent.name} Agent (${agent.slug}) - ${agent.responsibility}`
          )
          .join('\n');
        let prompt = `I want to run the Ralph Orchestrator for Rumfor Market Tracker.\n\n` +
          `Please run a complete development cycle with all specialist agents:\n` +
          `${lines}\n\n`;
        if (selectedCards.length) {
          selectedCards.forEach(card => {
            prompt += `Context from World Model card "${card.id}":\n${card.prompt}\n\n`;
          });
          prompt += `Please use this context while working as the Ralph Orchestrator.\n\n`;
        }
        prompt += `Switch to the ralph-orchestrator mode and run a full cycle with all agents.`;
        return prompt;
      }

      function slugify(value) {
        return value.replace(/[^a-z0-9-_]/gi, '_').toLowerCase();
      }

      function renderCardDetail(card) {
        const detail = document.getElementById('card-detail');
        detail.classList.remove('muted');
        detail.innerHTML = `
          <h3 style="margin: 0 0 8px 0;">${card.label}</h3>
          <div class="muted" style="margin-bottom: 8px;">${card.id} â€¢ ${card.type}</div>
          <div class="section-title" style="margin-top: 12px;">Prompt</div>
          <p>${card.prompt}</p>
          <div class="section-title" style="margin-top: 12px;">Files</div>
          <div class="muted">DOT: ${card.file}</div>
          <div class="muted">Notes: ${card.notes}</div>
        `;
      }

      function updateEditorStatus(card) {
        const status = document.getElementById('editor-status');
        const editorFiles = document.getElementById('editor-files');
        if (!card) {
          status.innerHTML = `
            <div><strong>Steps:</strong> 1) Select a card 2) Edit fields 3) Save</div>
            <div>Saving writes directly to <code>cards/</code> (no file browser).</div>
          `;
          editorFiles.textContent = 'Files will save to cards/ using the card ID.';
          return;
        }
        status.innerHTML = `Editing <span class="pill">${card.label}</span> <span class="muted">(${card.id})</span>`;
        editorFiles.innerHTML = `DOT: <code>${card.file}</code> â€¢ Notes: <code>${card.notes}</code>`;
      }

      async function loadCardIntoEditor(card) {
        selectedCard = card;
        document.getElementById('card-id').value = card.id || '';
        document.getElementById('card-label').value = card.label || '';
        document.getElementById('card-type').value = card.type || 'card';
        document.getElementById('card-prompt').value = card.prompt || '';
        const notesField = document.getElementById('card-notes');
        notesField.value = '';
        if (card.notes) {
          try {
            const response = await fetch(`http://localhost:3001/api/ralph/cards/notes/${card.notes}`);
            if (response.ok) {
              notesField.value = await response.text();
            } else {
              notesField.placeholder = 'Notes file not found.';
            }
          } catch (error) {
            notesField.placeholder = 'Unable to load notes file.';
          }
        }
        updateEditorStatus(card);
      }

      function renderAgents() {
        const grid = document.getElementById('agent-grid');
        grid.innerHTML = '';
        agents.forEach(agent => {
          const status = (window.ralphStatus?.agents?.[agent.id]?.status) || 'idle';
          const message = (window.ralphStatus?.agents?.[agent.id]?.message) || 'Ready';
          const div = document.createElement('div');
          div.className = 'agent';
          div.innerHTML = `
            <div>
              <div>${agent.icon} ${agent.name}</div>
              <div class="muted status-${status}">${message}</div>
            </div>
            <button data-agent="${agent.id}">Copy</button>
          `;
          div.querySelector('button').addEventListener('click', () => {
            navigator.clipboard.writeText(buildPrompt(agent));
            showToast(`${agent.name} prompt copied`);
          });
          grid.appendChild(div);
        });
      }

      function renderOrchestrator() {
        const orch = window.ralphStatus?.orchestrator || {};
        document.getElementById('orchestrator-status').textContent = `Status: ${orch.status || 'idle'}`;
        document.getElementById('orchestrator-cycle').textContent = `Cycle: ${orch.current_cycle ?? 0}`;
        document.getElementById('orchestrator-agent').textContent = `Current: ${orch.current_agent || '-'}`;
      }

      function buildDotCard() {
        const cardId = document.getElementById('card-id').value.trim() || 'Card.New';
        const label = document.getElementById('card-label').value.trim() || cardId;
        const type = document.getElementById('card-type').value;
        const prompt = document.getElementById('card-prompt').value.trim().replace(/"/g, '\\"');
        return `digraph WorldModel {\n  "ROOT" [label="Rumfor Market Tracker", type="root"];\n  "ROOT" -> "${cardId}";\n  "${cardId}" [label="${label}", type="${type}", prompt="${prompt}"];\n}`;
      }

      function buildNotesContent() {
        return document.getElementById('card-notes').value.trim();
      }

      function updateSelectedCardFromEditor() {
        const cardId = document.getElementById('card-id').value.trim() || 'Card.New';
        const label = document.getElementById('card-label').value.trim() || cardId;
        const type = document.getElementById('card-type').value;
        const prompt = document.getElementById('card-prompt').value.trim();
        const dotFile = selectedCard?.file || `${slugify(cardId)}.dot`;
        const notesFile = selectedCard?.notes || `${slugify(cardId)}.md`;

        if (selectedCard) {
          selectedCard.id = cardId;
          selectedCard.label = label;
          selectedCard.type = type;
          selectedCard.prompt = prompt;
          selectedCard.file = dotFile;
          selectedCard.notes = notesFile;
        } else {
          selectedCard = {
            id: cardId,
            label,
            type,
            prompt,
            file: dotFile,
            notes: notesFile,
          };
          cardsCache = [selectedCard, ...cardsCache];
        }
        window.ralphCards = cardsCache;
        renderCards(cardsCache);
        renderCardDetail(selectedCard);
        updateEditorStatus(selectedCard);
      }

      document.getElementById('card-save').addEventListener('click', async () => {
        updateSelectedCardFromEditor();
        const payload = {
          card: selectedCard,
          notesContent: buildNotesContent()
        };
        try {
          const response = await fetch('http://localhost:3001/api/ralph/cards/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            throw new Error('Save failed');
          }
          const data = await response.json();
          if (data?.card) {
            selectedCard = data.card;
            const index = cardsCache.findIndex((entry) => entry.id === selectedCard.id);
            if (index >= 0) {
              cardsCache[index] = selectedCard;
            } else {
              cardsCache.unshift(selectedCard);
            }
            window.ralphCards = cardsCache;
            renderCards(cardsCache);
            renderCardDetail(selectedCard);
            updateEditorStatus(selectedCard);
          }
          showToast('Card saved');
        } catch (error) {
          showToast('Save failed â€” ensure backend is running');
        }
      });

      document.getElementById('card-clear').addEventListener('click', () => {
        selectedCard = null;
        document.getElementById('card-id').value = '';
        document.getElementById('card-label').value = '';
        document.getElementById('card-type').value = 'category';
        document.getElementById('card-prompt').value = '';
        document.getElementById('card-notes').value = '';
        updateEditorStatus(null);
        showToast('Editor cleared');
      });


      document.getElementById('run-all').addEventListener('click', () => {
        navigator.clipboard.writeText(buildRunAllPrompt());
        showToast('Orchestrator prompt copied');
      });

      async function loadCards() {
        try {
          const response = await fetch('http://localhost:3001/api/ralph/cards/index');
          const data = await response.json();
          cardsCache = data.cards || [];
          window.ralphCards = cardsCache;
          renderCards(cardsCache);
          return;
        } catch (error) {
          if (window.ralphCards) {
            cardsCache = window.ralphCards;
            renderCards(cardsCache);
            return;
          }
          cardsCache = [];
          renderCards(cardsCache);
        }
      }

      function renderCards(cards) {
        const list = document.getElementById('cards-list');
        list.innerHTML = '';
        if (!cards.length) {
          list.innerHTML = '<div class="muted">No cards found. Add .dot files in cards/.</div>';
          document.getElementById('cards-count').textContent = '0';
          return;
        }
        document.getElementById('cards-count').textContent = `${cards.length}`;
        cards.forEach(card => {
          const item = document.createElement('div');
          const isSelected = selectedCards.some((entry) => entry.id === card.id);
          item.className = `card-item${isSelected ? ' selected' : ''}`;
          item.innerHTML = `
            <div class="meta-row">
              <strong>${card.label}</strong>
              <span class="badge">${card.type}</span>
            </div>
            <div class="muted">${card.id}</div>
            <div class="muted prompt-preview">${card.prompt}</div>
          `;
          item.addEventListener('click', () => {
            const existingIndex = selectedCards.findIndex((entry) => entry.id === card.id);
            if (existingIndex >= 0) {
              selectedCards.splice(existingIndex, 1);
            } else {
              selectedCards.push(card);
            }
            selectedCard = card;
            renderCardDetail(card);
            loadCardIntoEditor(card);
            renderCards(cardsCache || []);
          });
          list.appendChild(item);
        });
      }

      function filterCards(query) {
        const q = query.trim().toLowerCase();
        const source = cardsCache || [];
        if (!q) {
          renderCards(source);
          return;
        }
        const filtered = source.filter(card =>
          card.label.toLowerCase().includes(q) ||
          card.id.toLowerCase().includes(q) ||
          card.prompt.toLowerCase().includes(q)
        );
        renderCards(filtered);
      }

      renderOrchestrator();
      renderAgents();
      loadCards();
      document.getElementById('cards-filter').addEventListener('input', (event) => {
        filterCards(event.target.value);
      });
    </script>
  </body>
</html>
